---
import AuthLayout from "@/layouts/AuthLayout.astro";
import { ResetPasswordRequestForm } from "@/components/auth/ResetPasswordRequestForm";
import { UpdatePasswordForm } from "@/components/auth/UpdatePasswordForm";
import { createSupabaseServerInstance } from "@/db/supabase.client";

const searchParams = Astro.url.searchParams;
const code = searchParams.get("code");
const token = searchParams.get("token");
const tokenHash = searchParams.get("token_hash") ?? token;
const tokenType = searchParams.get("type");
const hasRecoveryQuery = Boolean(tokenHash) || tokenType === "recovery" || searchParams.get("mode") === "update";
const errorParam = searchParams.get("error");
const statusParam = searchParams.get("status");
let hasRecoveryToken = Boolean(code) || hasRecoveryQuery;
let initialError = errorParam;

if (code) {
  const supabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

  const { error } = await supabase.auth.exchangeCodeForSession(code);

  if (!error) {
    const redirectUrl = new URL("/auth/reset-password", Astro.url);
    redirectUrl.searchParams.set("mode", "update");
    if (statusParam) redirectUrl.searchParams.set("status", statusParam);
    return Astro.redirect(`${redirectUrl.pathname}${redirectUrl.search}`);
  }

  hasRecoveryToken = false;
  initialError = "invalid_recovery";
}

if (!code && tokenHash && tokenType === "recovery") {
  const supabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

  const { error } = await supabase.auth.verifyOtp({
    type: "recovery",
    token_hash: tokenHash,
  });

  if (!error) {
    const redirectUrl = new URL("/auth/reset-password", Astro.url);
    redirectUrl.searchParams.set("mode", "update");
    if (statusParam) redirectUrl.searchParams.set("status", statusParam);
    return Astro.redirect(`${redirectUrl.pathname}${redirectUrl.search}`);
  }

  hasRecoveryToken = false;
  initialError = "invalid_recovery";
}
---

<AuthLayout title="Reset hasÅ‚a | Damix 10x Cards">
  {
    hasRecoveryToken ? (
      <UpdatePasswordForm initialError={initialError} client:load />
    ) : (
      <ResetPasswordRequestForm initialError={initialError} initialSuccess={statusParam === "sent"} client:load />
    )
  }
</AuthLayout>
