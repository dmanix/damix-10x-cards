name: Pull Request

on:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Setup Node and install deps
        uses: ./.github/actions/setup-node

      - name: Lint code
        run: npm run lint

  unit-test:
    runs-on: ubuntu-latest
    needs: lint
    env:
      NODE_ENV: test
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Setup Node and install deps
        uses: ./.github/actions/setup-node

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload unit test coverage
        uses: actions/upload-artifact@v6
        with:
          name: unit-coverage
          path: coverage
          if-no-files-found: error

  e2e-test:
    runs-on: ubuntu-latest
    needs: lint
    environment: integration
    env:
      NODE_ENV: integration
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      LOG_LEVEL: ${{ vars.LOG_LEVEL }}
      LOG_OUTPUT: ${{ vars.LOG_OUTPUT }}
      LOG_FILE_PATH: ${{ vars.LOG_FILE_PATH }}
      E2E_USERNAME_ID: ${{ secrets.E2E_USERNAME_ID }}
      E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
      E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Setup Node and install deps
        uses: ./.github/actions/setup-node

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run e2e tests with coverage
        env:
          NODE_V8_COVERAGE: ./coverage-e2e
        run: npm run test:e2e

      - name: Upload e2e coverage and reports
        uses: actions/upload-artifact@v6
        with:
          name: e2e-coverage
          path: |
            coverage-e2e
            playwright-report
            test-results
          if-no-files-found: warn

  status-comment:
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test]
    if: ${{ always() }}
    permissions:
      contents: read
      pull-requests: write
    env:
      LINT_RESULT: ${{ needs.lint.result }}
      UNIT_RESULT: ${{ needs.unit-test.result }}
      E2E_RESULT: ${{ needs.e2e-test.result }}
    steps:
      - name: Comment PR with status
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const artifactsUrl = `${runUrl}/artifacts`;
            const results = {
              lint: process.env.LINT_RESULT,
              unit: process.env.UNIT_RESULT,
              e2e: process.env.E2E_RESULT,
            };
            const isSuccess = Object.values(results).every((r) => r === "success");
            const header = isSuccess
              ? "✅ Pull request checks passed."
              : "❌ Pull request checks failed.";
            const summary = [
              header,
              "",
              `- Lint: ${results.lint}`,
              `- Unit tests: ${results.unit}`,
              `- E2E tests: ${results.e2e}`,
              `- Artifacts: [unit-coverage](${artifactsUrl}) | [e2e-coverage](${artifactsUrl})`,
              `- Run: ${runUrl}`,
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: summary,
            });
